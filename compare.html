<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compare Stocks - StockSim</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/themes.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="bi bi-graph-up-arrow"></i> StockSim
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="market.html">Market</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="portfolio.html">Portfolio</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="watchlist.html">Watchlist</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Compare Header -->
    <div class="dashboard-header">
        <div class="container py-4">
            <h2 class="mb-4">
                <i class="bi bi-bar-chart"></i> Compare Stocks
            </h2>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container my-4">
        <!-- Stock Selection -->
        <div class="row mb-4">
            <div class="col-md-5">
                <label class="form-label">Select First Stock</label>
                <select class="form-select" id="stock1Select">
                    <option value="">Choose a stock...</option>
                </select>
            </div>
            <div class="col-md-2 text-center align-self-end">
                <h3>VS</h3>
            </div>
            <div class="col-md-5">
                <label class="form-label">Select Second Stock</label>
                <select class="form-select" id="stock2Select">
                    <option value="">Choose a stock...</option>
                </select>
            </div>
        </div>

        <!-- Comparison Results -->
        <div id="comparisonResults" class="d-none">
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0" id="stock1Name">Stock 1</h5>
                        </div>
                        <div class="card-body" id="stock1Details">
                            <!-- Stock 1 details -->
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0" id="stock2Name">Stock 2</h5>
                        </div>
                        <div class="card-body" id="stock2Details">
                            <!-- Stock 2 details -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Comparison Chart -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Price Comparison Chart</h5>
                </div>
                <div class="card-body">
                    <canvas id="comparisonChart" height="300"></canvas>
                </div>
            </div>

            <!-- Side-by-Side Comparison Table -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Detailed Comparison</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead class="table-dark">
                                <tr>
                                    <th>Metric</th>
                                    <th id="tableStock1">Stock 1</th>
                                    <th id="tableStock2">Stock 2</th>
                                    <th>Winner</th>
                                </tr>
                            </thead>
                            <tbody id="comparisonTableBody">
                                <!-- Comparison rows -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/main.js"></script>
    <script src="js/theme.js"></script>
    <script>
        let stock1 = null;
        let stock2 = null;
        let chartContext = null;

        document.addEventListener('DOMContentLoaded', () => {
            StorageManager.init();
            populateStockSelects();
            setupChart();
            
            // Get symbol from URL
            const urlParams = new URLSearchParams(window.location.search);
            const symbol1 = urlParams.get('symbol1');
            if (symbol1) {
                document.getElementById('stock1Select').value = symbol1;
                document.getElementById('stock1Select').dispatchEvent(new Event('change'));
            }

            document.getElementById('stock1Select').addEventListener('change', handleStockSelection);
            document.getElementById('stock2Select').addEventListener('change', handleStockSelection);
        });

        function populateStockSelects() {
            const select1 = document.getElementById('stock1Select');
            const select2 = document.getElementById('stock2Select');

            StockData.forEach(stock => {
                const option1 = new Option(`${stock.symbol} - ${stock.name}`, stock.symbol);
                const option2 = new Option(`${stock.symbol} - ${stock.name}`, stock.symbol);
                select1.add(option1);
                select2.add(option2);
            });
        }

        function handleStockSelection() {
            const symbol1 = document.getElementById('stock1Select').value;
            const symbol2 = document.getElementById('stock2Select').value;

            stock1 = symbol1 ? StockData.find(s => s.symbol === symbol1) : null;
            stock2 = symbol2 ? StockData.find(s => s.symbol === symbol2) : null;

            if (stock1 && stock2 && stock1.symbol !== stock2.symbol) {
                displayComparison();
            } else {
                document.getElementById('comparisonResults').classList.add('d-none');
            }
        }

        function displayComparison() {
            const priceData = JSON.parse(localStorage.getItem('stockPrices') || '{}');
            const data1 = priceData[stock1.symbol] || { price: stock1.basePrice, changePercent: 0 };
            const data2 = priceData[stock2.symbol] || { price: stock2.basePrice, changePercent: 0 };

            // Update stock names
            document.getElementById('stock1Name').textContent = `${stock1.symbol} - ${stock1.name}`;
            document.getElementById('stock2Name').textContent = `${stock2.symbol} - ${stock2.name}`;
            document.getElementById('tableStock1').textContent = stock1.symbol;
            document.getElementById('tableStock2').textContent = stock2.symbol;

            // Stock 1 details
            document.getElementById('stock1Details').innerHTML = `
                <div class="h3 mb-3 ${data1.changePercent >= 0 ? 'text-success' : 'text-danger'}">
                    ${Utils.formatCurrency(data1.price)}
                </div>
                <div class="mb-2">
                    <strong>Change:</strong> 
                    <span class="${data1.changePercent >= 0 ? 'text-success' : 'text-danger'}">
                        ${Utils.formatPercent(data1.changePercent)}
                    </span>
                </div>
                <div class="mb-2"><strong>Category:</strong> ${stock1.category}</div>
                <div class="mb-2"><strong>Volume:</strong> ${(stock1.volume / 1000000).toFixed(1)}M</div>
                <div class="mb-2"><strong>Base Price:</strong> ${Utils.formatCurrency(stock1.basePrice)}</div>
                <div class="mt-3">
                    <a href="stock-details.html?symbol=${stock1.symbol}" class="btn btn-primary btn-sm">
                        View Details
                    </a>
                </div>
            `;

            // Stock 2 details
            document.getElementById('stock2Details').innerHTML = `
                <div class="h3 mb-3 ${data2.changePercent >= 0 ? 'text-success' : 'text-danger'}">
                    ${Utils.formatCurrency(data2.price)}
                </div>
                <div class="mb-2">
                    <strong>Change:</strong> 
                    <span class="${data2.changePercent >= 0 ? 'text-success' : 'text-danger'}">
                        ${Utils.formatPercent(data2.changePercent)}
                    </span>
                </div>
                <div class="mb-2"><strong>Category:</strong> ${stock2.category}</div>
                <div class="mb-2"><strong>Volume:</strong> ${(stock2.volume / 1000000).toFixed(1)}M</div>
                <div class="mb-2"><strong>Base Price:</strong> ${Utils.formatCurrency(stock2.basePrice)}</div>
                <div class="mt-3">
                    <a href="stock-details.html?symbol=${stock2.symbol}" class="btn btn-primary btn-sm">
                        View Details
                    </a>
                </div>
            `;

            // Comparison table
            const tableBody = document.getElementById('comparisonTableBody');
            const comparisons = [
                { label: 'Current Price', value1: data1.price, value2: data2.price, higher: 'better' },
                { label: 'Day Change %', value1: data1.changePercent, value2: data2.changePercent, higher: 'better' },
                { label: 'Base Price', value1: stock1.basePrice, value2: stock2.basePrice, higher: 'neutral' },
                { label: 'Volume', value1: stock1.volume, value2: stock2.volume, higher: 'better' },
                { label: 'Price per Share', value1: data1.price, value2: data2.price, higher: 'neutral' }
            ];

            tableBody.innerHTML = comparisons.map(comp => {
                const winner = comp.higher === 'better' 
                    ? (comp.value1 > comp.value2 ? stock1.symbol : stock2.symbol)
                    : comp.higher === 'neutral' ? 'Equal' : (comp.value1 < comp.value2 ? stock1.symbol : stock2.symbol);
                
                const formatValue = (val) => {
                    if (typeof val === 'number') {
                        if (val > 1000) return Utils.formatCurrency(val);
                        if (val > 1) return val.toFixed(2);
                        return Utils.formatPercent(val);
                    }
                    return val;
                };

                return `
                    <tr>
                        <td><strong>${comp.label}</strong></td>
                        <td>${formatValue(comp.value1)}</td>
                        <td>${formatValue(comp.value2)}</td>
                        <td><span class="badge bg-primary">${winner}</span></td>
                    </tr>
                `;
            }).join('');

            // Update chart
            updateChart(data1.price, data2.price);

            document.getElementById('comparisonResults').classList.remove('d-none');
        }

        function setupChart() {
            const canvas = document.getElementById('comparisonChart');
            if (!canvas) return;
            canvas.width = canvas.offsetWidth;
            canvas.height = 300;
            chartContext = canvas.getContext('2d');
        }

        function updateChart(price1, price2) {
            if (!chartContext || !stock1 || !stock2) return;

            const canvas = document.getElementById('comparisonChart');
            const ctx = chartContext;
            const width = canvas.width;
            const height = canvas.height;
            const padding = 60;

            ctx.clearRect(0, 0, width, height);

            // Draw bars
            const maxPrice = Math.max(price1, price2) * 1.2;
            const barWidth = (width - 2 * padding) / 4;
            const bar1Height = (price1 / maxPrice) * (height - 2 * padding);
            const bar2Height = (price2 / maxPrice) * (height - 2 * padding);

            // Stock 1 bar
            ctx.fillStyle = '#0d6efd';
            ctx.fillRect(padding, height - padding - bar1Height, barWidth, bar1Height);
            ctx.fillStyle = '#000';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(stock1.symbol, padding + barWidth / 2, height - 10);
            ctx.fillText(Utils.formatCurrency(price1), padding + barWidth / 2, height - padding - bar1Height - 10);

            // Stock 2 bar
            ctx.fillStyle = '#198754';
            ctx.fillRect(padding + barWidth * 2, height - padding - bar2Height, barWidth, bar2Height);
            ctx.fillStyle = '#000';
            ctx.fillText(stock2.symbol, padding + barWidth * 2.5, height - 10);
            ctx.fillText(Utils.formatCurrency(price2), padding + barWidth * 2.5, height - padding - bar2Height - 10);
        }

        window.addEventListener('resize', () => {
            setupChart();
            if (stock1 && stock2) {
                const priceData = JSON.parse(localStorage.getItem('stockPrices') || '{}');
                const data1 = priceData[stock1.symbol] || { price: stock1.basePrice };
                const data2 = priceData[stock2.symbol] || { price: stock2.basePrice };
                updateChart(data1.price, data2.price);
            }
        });
    </script>
</body>
</html>

